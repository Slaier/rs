# MAC

---

## 1. MAC地址

MAC地址共48位（6个字节），以十六进制表示。前24位由IEEE决定如何分配，后24位由实际生产该网络设备的厂商自行指定。

`ff:ff:ff:ff:ff:ff`则作为广播地址，`01:xx:xx:xx:xx:xx`是多播地址。

---

## 2. 二层交换原理

二层交换设备通过解析和学习以太网帧的源MAC来维护MAC地址与接口的对应关系（保存MAC与接口对应关系的表称为MAC表），通过其目的MAC来查找MAC表决定向哪个接口转发，基本流程如下：


二层交换设备收到以太网帧，将其源MAC与接收接口的对应关系写入MAC表，作为以后的二层转发依据。如果MAC表中已有相同表项，那么就刷新该表项的老化时间。MAC表表项采取一定的老化更新机制，老化时间内未得到刷新的表项将被删除掉。

设备判断目的MAC地址是不是广播地址：
  - 如果目的MAC地址是广播地址，那么向所有接口转发（报文的入接口除外）。
  - 如果目的MAC地址不是广播地址，根据以太网帧的目的MAC去查找MAC表，如果能够找到匹配表项，则向表项所示的对应接口转发，如果没有找到匹配表项，那么向所有接口转发（报文的入接口除外）。

从上述流程可以看出，二层交换通过维护MAC表以及根据目的MAC查表转发，有效的利用了网络带宽，改善了网络性能。

---

## 3. MAC学习

MAC学习是基于帧的**源MAC**学习的。

HostA向SwitchA发送数据时，SwitchA从数据帧中解析出源MAC地址（即HostA的MAC地址）和VLAN ID。

+ 如果MAC地址表中不存在该MAC地址表项，设备则将这个新MAC地址以及该MAC地址对应的PortA和VLAN ID作为一个新的表项加入到MAC地址表中。
+ 如果MAC地址表中已经存在该MAC地址表项，设备将通过重置该表项的老化时间，对该表项进行更新。

---

## 4. MAC老化

由于MAC地址表的表项数目有限，所以需要进行老化。

+ 收到`源MAC`匹配的帧后，将表项的hit标记为`1`

设备周期性地对所有学习到的动态MAC地址表项进行检查。

+ 若hit位为`1`，则修改为`0`
+ 若hit位为`0`，则老化删除

MAC老化周期检测时间默认为`300`s, 实际老化时间为老化周期1～2倍.

---

## MAC表项分类

+ 动态表项
  + 由接口通过报文中的源MAC地址学习获得，表项可老化
+ 静态表项
  + 由用户手工配置，并下发到各接口板，表项不可老化

---

## MAC地址漂移

MAC地址漂移是指设备上一个VLAN内有两个端口学习到同一个MAC地址，后学习到的MAC地址表项覆盖原MAC地址表项的现象，出现这种现象一般都意味着网络中存在环路。

+ 解决手段
  + 设置静态MAC
  + 为MAC设置优先级，禁止高优先级向低优先级漂移
  + 不允许相同优先级之间进行漂移

---

## 端口桥接

允许从本端口进入的报文再从本端口发送出去。